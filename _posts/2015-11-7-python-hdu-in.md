---
layout: post
title: python爬虫之教务系统
tags: [python, study]
category: Python
---
> 想要获取周一至周五教室使用情况，以寻觅一可安定自习的地方。于是便打起了教务系统的主意，刚学的python爬虫拿来用用也很不错。

打开大门
---
要探索内部，必然要先进门。教务系统使用了CAS，通过firefox控制器持续日志记录，可以分析整个登录流程。

> ps:firefox控制台设置“启用持续日志”，便可持续截获http请求，好用程度不亚于httpfox

![]({{site.img_dir}}{{page.dir}}/2015-11-07-python-hdu-in.png)

分析登录流程以及页面内js操作，可知：

1. ```login?service=http://jxgl.hdu.edu.cn/index.aspx```作为登录入口页不仅向```cas/login```进行了表单提交。分析其js部分，首先，在该页面中每重载一次或是提交失败一次，都会产生一个新的**lt**值，作为隐藏的input放置在页面中；其次，在表单提交前会对密码进行md5加密。因此，额外需要做的便是确定正确密码加密值，对```login?service=http://jxgl.hdu.edu.cn/index.aspx```GET一下，获取到页面中**lt**值，和其他表单数据一并提交。另，切记headers中要设置上传流数据```
	"Content-Type": "application/x-www-form-urlencoded"```

2. 通过```cas/login```验证后能在响应头中获取到CAS_SERVICE和CAS_TICKET，组合之得到认证页面的url，即```CAS_SERVICE?ticket=CAS_TICKET```，GET该页面，若ticket值正确的话可以看到页面内容，一个POST表单，表单数据为_VIEWSTATE。这时就已经通过CAS SERVE的认证了。

3. GET 教务系统内容入口页```xs_main.aspx```，即可成功进入。

小试：获取成绩
---
作为对教务系统的熟悉，首先拿成绩获取做一实验。在教务系统中一学期一学期的查看成绩实在是麻烦，不如做成输入学号和密码即可列出至今所有成绩。

#### 查询流程

首先，研究一下成绩查询的流程。重新查看xs_main.aspx的html结构，可以发现菜单栏目选项都是使用超链接实现跳转的，暂时只需要成绩查询这一项的url，暂称其为urlA。点击菜单项发现是一个GET请求，并没有获取和显示成绩，切换学期和学年则是GET了一个新页面。点击查询，显示成绩信息，通过控制台发现这是一个POST请求，发送的表单参数中除了学年学期，还有一些陌生的数据。在页面中查找发现这些数据放置在是隐藏的input中，这时便设想到GET操作是否与这些数据有关，果不其然，一个新页面中的这些数据都不相同。所以，要获取每学年每学期的成绩需要做两步操作：
	1. 发送GET请求获取urlA对应的页面，组装其中的input值。
	2. 使用组装好的值以及学年学期数据，向urlA发送POST请求，获取到含有成绩内容的页面。

#### 获取内容

传统地通过正则表达式获取，目前使用简陋笨拙的方法。根据学号推出入学年份作为起始学年，当前年份为结束学年，在起始学年和结束学年之间做迭代请求。在请求来的页面中先用一个table匹配正则获取整张表，再使用一个tr匹配正则findall行元素，将所有行元素合并至一个数组中，对每一个行元素做字符串处理（去除前后空格，替换```<td>```标签，替换```&nbsp;```,使用```</td>```切分成数组）。将单元格的内容对应存入数据库(score表和course表)。




